{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/track.ts", "../src/baseHandler.ts", "../src/reactive.ts"],
  "sourcesContent": ["//\u7528\u4E8E\u540E\u7EED\u5C06\u5F53\u524D\u7684effect\u548C\u540E\u7EED\u54CD\u5E94\u5F0F\u6570\u636E\u7684\u6539\u53D8\u5173\u8054\u8D77\u6765\nexport type activeEffect = void | ReactiveEffect;\nexport let activeEffect: activeEffect; //\u8054\u5408\u7C7B\u578B\u91CC\u51FD\u6570\u9700\u8981\u88AB\u62EC\u53F7\u62EC\u8D77\u6765\nclass ReactiveEffect {\n  _trackId = 0;\n  _deps: Map<any, any>[] = []; //\u7528\u4E8E\u5B58\u653E\u5F53\u524Deffect\u91CC\u6709\u591A\u5C11\u4E2Adep\n  _depsLength = 0; //\u4E3B\u8981\u7528\u4E8E\u8BB0\u5F55\u4E0A\u4E00\u6B21\u4F9D\u8D56\u7684\u4E2A\u6570 \u540E\u7EED\u901A\u8FC7\u6BD4\u8F83\u65B0\u8001length \u5220\u9664\u591A\u4F59\u7684\u4F9D\u8D56\n  private parent?: activeEffect;\n  constructor(private fn: () => void, private schedule: () => void) {} //\u4F1A\u88AB\u8F6C\u5316\u4E3Aconstructor(){this.fn = fn}\n  _run() {\n    //\u5F53\u524D\u4EE3\u7801\u6709\u4E2A\u95EE\u9898\u5C31\u662F\u5F53\u5D4C\u5957\u7684effect\u4F1A\u51FA\u73B0\u95EE\u9898\n    //\u4EE3\u7801\u4F8B\u5B50\n    // import { reactive, effect } from \"./reactivity.js\";\n    // const target = {\n    //   name: 1,\n    //   pink: 2,\n    //   address: 3,\n    // };\n    // const state = reactive(target);\n    // effect(() => {\n    //   console.log(state.name); //\u5F53\u524DactiveEffect\u5BF9\u5E94\u7684\u662F\u5F53\u524D\u7684effect\n    //     effect(() => {\n    //   console.log(state.address);//\u5F53\u524DactiveEffect\u5BF9\u5E94\u7684\u662F\u5F53\u524D\u7684effect\u4F46\u662F\u6267\u884C\u5B8C\u8FD9\u53E5activeEffect\u4F1A\u53D8\u6210undefined\n    // })\n    //   console.log(state.pink); //\u8FD9\u4E2A\u65F6\u5019\u8FD9\u4E2A\u91CC\u5BF9\u5E94\u7684activeEffect\u4E3Aundefined\n    // });\n    preClean(this);\n    try {\n      //\u6BCF\u6B21\u8FDB\u6765\u90FD\u8981\u5C06parent\u8BBE\u7F6E\u4E3A\u4E0A\u4E00\u4E2AactiveEffect\n      this.parent = activeEffect;\n      activeEffect = this;\n      return this.fn();\n    } finally {\n      activeEffect = this.parent;\n    }\n  }\n}\nfunction preClean(effect: ReactiveEffect) {\n  effect._trackId++;\n  //\u6BCF\u4E00\u6B21\u6267\u884C\u9700\u8981\u5C06trackId++ \u7528\u4E8E\u5C06\u540C\u4E00\u4E2Aeffect\u89E6\u53D1\u591A\u4E2A\u76F8\u540Cdep\u65F6\u5019\u9700\u8981\u53BB\u91CD\n  // effect(() => {\n  //   state.name;\n  //   state.name;\n  //   //\u7531\u4E8E\u662F\u540C\u4E00\u4E2Aeffect \u6240\u4EE5\u4E0D\u9700\u8981\u89E6\u53D1 \u4E0D\u9700\u8981\u5B58\u5728dep \u53EF\u4EE5\u901A\u98CEtrackId\u533A\u5206\n  // })\n  // effect(() => {\n  //   state.name;\n  //   effect(() => {\n  //     state.name;   //\u8FD9\u6837\u5C31\u8981\u5C06\u8FD9\u4E2Aeffect\u63A8\u5165\u5230\u5F53\u524D\u7684dep\u56E0\u4E3Aeffect\u5E76\u4E0D\u76F8\u540C\n  //   })\n  // })\n  effect._depsLength = 0; //\u5C06\u8BE5\u503C\u91CD\u7F6E\u4E3A0 \u540E\u7EED\u5C06\u7528\u4E8E\u65B0\u8001dep\u6E05\u7A7A\n}\nexport function effect(fn: () => void) {\n  const _effect = new ReactiveEffect(fn, () => {\n    _effect._run();\n  });\n  return _effect._run();\n}\n", "export function isObject(value: any): boolean {\n  return typeof value === \"object\" && value != null;\n}\n", "import { activeEffect, effect } from \"./effect\";\ntype Exclude<T, U> = T extends U ? never : T;\nconst reactiveEffectMap = new WeakMap();\nfunction createDep(cleanup: () => void, key: PropertyKey) {\n  const dep = new Map();\n  dep.set(\"cleanup\", cleanup);\n  dep.set(\"name\", key);\n  return dep;\n}\nexport function track(target: object, key: PropertyKey) {\n  //\u53EA\u5728effect\u51FD\u6570\u91CC\u6536\u96C6\u4F9D\u8D56\u5373activeEffect\u4E0D\u4E3A\u7A7A\n  if (!activeEffect) return;\n  let depsMap = reactiveEffectMap.get(target);\n  if (!depsMap) {\n    reactiveEffectMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key);\n  if (!dep) {\n    depsMap.set(key, (dep = createDep(() => dep.delete(key), key)));\n  }\n  trackEffect(activeEffect, dep);\n  // const target =\n  // //\u9700\u8981\u6784\u5EFA\u4E00\u4E2Amap\u7531\u4E8E\u6536\u96C6\u4F9D\u8D56\n  // {\n  //     {name:1,iphone:2}:{\n  //         name:{\n  //             effect\n  //         },\n  //         key2:{\n  //             effect\n  //         }\n  //     }\n  // }\n  //\u9700\u8981\u5C06effect\u548Cdep\u505A\u5173\u8054 \u8FD9\u6837\u5F53\u76F8\u5173\u7684dep\u6539\u53D8 \u5C31\u53EF\u4EE5\u53BB\u627E\u5230effect\u6267\u884C\n  // name\u6539\u53D8\u5C31\u8981\u53BB\u89E6\u53D1effect\n}\n// const state = reactive({\n//   name:'1',\n//   pink:2\n// }\n// effect(() => {\n//   state.name;\n//   state.name; //\u4E0D\u5E94\u8BE5\u6536\u96C6\n// })\n//\u5C06effect\u548Cdep\u505A\u5173\u8054\nfunction trackEffect(effect: Exclude<activeEffect, void>, dep: Map<any, any>) {\n  if (dep.get(effect) !== effect._trackId) {\n    //\u5982\u679C\u8FD9\u4E2Adep\u91CC\u7684effect\u7684_trackId\u548C\u5F53\u524Deffect\u7684_trackId\u4E0D\u76F8\u7B49\u8BF4\u660E\u8FD9\u4E2Aeffect\u6CA1\u6709\u76D1\u542C\u8FC7\u8FD9\u4E2Adep\n    dep.set(effect, effect._trackId);\n    const oldDep = effect._deps[effect._depsLength];\n    if (oldDep === dep) {\n      effect._depsLength++;\n    } else {\n      console.log(\"dep\", oldDep);\n      oldDep && cleanEffectDep(effect, oldDep);\n      effect._deps[effect._depsLength++] = dep;\n    }\n    //\u5982\u679C\u65B0\u7684\u548C\u65E7\u7684\u4E00\u6837\u90A3\u5C31\u4FDD\u7559 \u4E0D\u4E00\u6837\u5C31\u5220\u9664\n    //\u5373\u4E0B\u9762\u6BCF\u4E00\u6B21\u5E94\u8BE5\u662F{name:depMap,pink:depMap} -> {name:depMap,address:depMap}\u800C\u4E0D\u662F{name:depMap,pink:depMap,address:depMap}\n    // effect(() => {\n    //   const a = state.name ? state.pink : state.address;\n    // });\n    // setTimeout(() => {\n    //   state.name = 0;\n    // }, 2000);\n    //\u901A\u8FC7effect\u53BB\u627Edep \u6211\u4EEC\u53EF\u4EE5\u505A\u4E2A\u7B80\u5355\u7684\u5BF9\u6BD4\n    // {flag,name}\n    // {flag,address}\n    //\u56E0\u4E3A\u5927\u90E8\u5206\u65F6\u5019\u4EE3\u7801\u4ECE\u4E0A\u5230\u4E0B\u6267\u884C\u987A\u5E8F\u4E0D\u53D8\u6240\u4EE5\u53EF\u4EE5\u901A\u8FC7\u6570\u7EC4\u987A\u5E8F\u5373\u53EF\n  }\n  //todo\n  //\u5C06\u6BCF\u4E2Aeffect\u5B58\u5230dep\u91CC \u4E00\u4E2Adep\u5728\u540C\u4E00\u4E2Aeffect\u4E2D\u53EA\u9700\u8981\u4E00\u6B21\u76D1\u542C\u4E0D\u9700\u8981\u591A\u6B21\n  // effect._trackId\n  // effect._deps[effect._depsLength++] = dep;\n  // console.log(reactiveEffectMap, \"map\");\n}\nexport function trigger(target: object, key: PropertyKey) {\n  const depsMap = reactiveEffectMap.get(target); //\u4ECEreactiveEffectMap\u91CC\u83B7\u53D6\u5BF9\u5E94\u7684dep\n  for (const effect of depsMap.get(key).keys()) {\n    effect.schedule && effect.schedule();\n  }\n}\nfunction cleanEffectDep(effect: activeEffect, dep: Map<any, any>) {\n  //\u8981\u4ECEoldDEP\u79FB\u9664effect\n  dep.delete(effect);\n  if (dep.size === 0) {\n    //\u5B58\u653E\u6BCF\u4E00\u4E2Aeffect \u5982\u679C\u4F9D\u8D56\u91CC\u6CA1\u6709\u957F\u5EA6\u4E86\u5C31\u5C06\u6240\u6709\u7684\u79FB\u9664\n    dep.get(\"cleanup\") && dep.get(\"cleanup\")();\n  }\n}\n", "import { track, trigger } from \"./track\";\nimport { activeEffect } from \"./effect\";\nexport enum ReactiveFlags {\n  IS_REACTIVE = \"__v_isReactive\",\n}\nexport const baseHandler = {\n  get(target: object, key: PropertyKey, receiver: any): any {\n    if (key === ReactiveFlags.IS_REACTIVE) {\n      return true;\n    }\n    activeEffect && track(target, key);\n    return Reflect.get(target, key, receiver);\n  },\n  set(\n    target: Record<PropertyKey, any>,\n    key: PropertyKey,\n    value: any,\n    receiver: any\n  ): boolean {\n    const oldValue = target[key];\n    Reflect.set(target, key, value, receiver); //\u9700\u8981\u5148\u6267\u884C\u4E00\u6B21\u4E0D\u7136effect\u6267\u884C\u65F6\u5019\u8FD8\u662F\u4E0A\u4E00\u6B21\u7684\u503C\n    if (oldValue !== value) {\n      trigger(target, key);\n    }\n    return Reflect.set(target, key, value, receiver);\n  },\n};\n", "import { isObject } from \"@mini-vue/shared\";\nimport { baseHandler, ReactiveFlags } from \"./baseHandler\";\nexport function reactive(raw: object) {\n  if (!isObject(raw)) {\n    return;\n  }\n  return createReactive(raw);\n}\nconst reactiveWeakMap = new WeakMap<object, any>();\nfunction createReactive<T extends object>(\n  obj: T & {\n    [ReactiveFlags.IS_REACTIVE]?: boolean;\n  }\n): T {\n  //\u9700\u8981\u4EE3\u7406\u8BE5\u5BF9\u8C61\n  if (reactiveWeakMap.has(obj)) {\n    //\u5982\u679C\u8BE5\u5BF9\u8C61\u88AB\u4EE3\u7406\u8FC7\u5219\u8FD4\u56DE\u4E4B\u524D\u7684\u4EE3\u7406\u5BF9\u8C61\n    return reactiveWeakMap.get(obj);\n  }\n  console.log(ReactiveFlags.IS_REACTIVE, \"lll\");\n  if (obj[ReactiveFlags.IS_REACTIVE]) {\n    return obj;\n  }\n  //   \u5982\u679C\u6539\u5BF9\u8C61\u5DF2\u7ECF\u662F\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61\u5C31\u76F4\u63A5\u8FD4\u56DE\n  const result = new Proxy(obj, baseHandler) as T;\n  //\u56E0\u4E3A\u5BF9\u8C61\u5982\u679C\u88AB\u4EE3\u7406\u9700\u8981\u8FD4\u56DE\u4E0A\u4E00\u6B21\u4EE3\u7406\u7684\u5BF9\u8C61\u6240\u4EE5\u9700\u8981\u5728\u6BCF\u4E00\u6B21\u5C06\u4EE3\u7406\u5BF9\u8C61\u5B58\u5230map\u91CC\u5982\u679C\u6709\u5C31\u76F4\u63A5\u8FD4\u56DE\n  reactiveWeakMap.set(obj, result);\n  return result;\n}\n"],
  "mappings": "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",
  "names": ["effect", "effect"]
}
